<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>InstallBase Form</title>

  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --text:#0f172a; --muted:#64748b;
      --border:#e5e7eb; --primary:#1a73e8; --radius:14px;
      --shadow: 0 10px 25px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px;}
    .header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px;}
    .title{font-size:18px;font-weight:700;color:#0f172a;}
    .sub{color:var(--muted);font-size:13px;margin-top:2px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;}
    fieldset{border:1px solid var(--border);border-radius:12px;padding:12px;margin:0 0 12px 0;}
    legend{padding:0 8px;color:#0f172a;font-weight:700;font-size:12px;letter-spacing:.3px;text-transform:uppercase;}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;align-items:start;}
    .f{grid-column:span 3;}
    .f.span-6{grid-column:span 6;}
    .f.span-12{grid-column:span 12;}

    /* Pro look: normal label weight */
    label{
      display:block;
      font-size:13px;
      color:#0f172a;
      font-weight:600;
      margin:0 0 6px 2px;
    }

    input, textarea{
      width:100%; border:1px solid var(--border); border-radius:12px;
      padding:10px 12px; outline:none; background:#fff; color:var(--text);
      font-size:14px;
    }
    textarea{min-height:84px;resize:vertical}
    input:focus, textarea:focus{border-color:var(--primary); box-shadow:0 0 0 4px rgba(26,115,232,.12);}

    .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px;}
    .btn{
      border:1px solid var(--border); background:#fff; padding:10px 14px;
      border-radius:12px; cursor:pointer; font-weight:700;
    }
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff;}

    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:6px 10px;border-radius:999px;border:1px solid var(--border);
      color:var(--muted);font-size:12px;background:#fff;
      white-space:nowrap;
    }
    .pill.loading{
      border-color: var(--primary);
      color: var(--primary);
      font-weight: 700;
    }
    .pill.loading::before{
      content:"";
      width:12px;height:12px;border-radius:50%;
      border:2px solid currentColor;
      border-right-color: transparent;
      display:inline-block;
      animation: spin .8s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    @media (max-width: 980px){
      .f{grid-column:span 6;}
      .f.span-6{grid-column:span 12;}
    }
    @media (max-width: 520px){
      .f{grid-column:span 12;}
      .header{flex-direction:column;align-items:flex-start}
      .actions{justify-content:stretch}
      .btn{width:100%}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div>
        <div class="title">KGK Jet India</div>
        <div class="title">InstallBase Entry Form</div>
        <div class="sub">Search by Customer / Serial, then update & save</div>
      </div>

      <div style="display:flex;gap:10px;align-items:center;">
        <div class="pill" id="todayPill">ðŸ“… Today: â€”</div>
        <div class="pill" id="loadingPill" style="display:none;">Loadingâ€¦</div>
      </div>
    </div>

    <form class="card" id="installbaseForm" autocomplete="off">

      <!-- SEARCH / UPDATE (TOP SAME AS YOU WANTED) -->
      <fieldset>
        <legend>Search / Update</legend>
        <div class="grid">
          <div class="f span-6">
            <label for="customer_name">Customer Name *</label>
            <input id="customer_name" name="customer_name" required list="dl_customer" placeholder="Type customer..." />
            <datalist id="dl_customer"></datalist>
          </div>

          <div class="f span-6">
            <label for="serial_no">Serial No *</label>
            <input id="serial_no" name="serial_no" required list="dl_serial" placeholder="Type serial..." />
            <datalist id="dl_serial"></datalist>
          </div>
        </div>
      </fieldset>

      <!-- BASIC -->
      <fieldset>
        <legend>Basic</legend>
        <div class="grid">
          <div class="f">
            <label for="zone">ZONE</label>
            <input id="zone" name="zone" type="text" />
          </div>
          <div class="f">
            <label for="sales_engr">SALES ENGR</label>
            <input id="sales_engr" name="sales_engr" type="text" />
          </div>
          <div class="f">
            <label for="service_engr">SERVICE ENGR</label>
            <input id="service_engr" name="service_engr" type="text" />
          </div>
          <div class="f">
            <label for="cluster_no">Cluster No</label>
            <input id="cluster_no" name="cluster_no" type="text" />
          </div>
        </div>
      </fieldset>

      <!-- CUSTOMER / LOCATION -->
      <fieldset>
        <legend>Customer / Location</legend>
        <div class="grid">
          <div class="f">
            <label for="location">LOCATION</label>
            <input id="location" name="location" type="text" />
          </div>
          <div class="f">
            <label for="state">STATE</label>
            <input id="state" name="state" type="text" />
          </div>
          <div class="f span-12">
            <label for="address">Address</label>
            <textarea id="address" name="address"></textarea>
          </div>
        </div>
      </fieldset>

      <!-- CONTACT 1 -->
      <fieldset>
        <legend>Contact Person 1</legend>
        <div class="grid">
          <div class="f span-6">
            <label for="contact_person1">Contact Person1</label>
            <input id="contact_person1" name="contact_person1" type="text" />
          </div>
          <div class="f">
            <label for="designation1">Designation</label>
            <input id="designation1" name="designation1" type="text" />
          </div>
          <div class="f">
            <label for="contact_no1">Contact No.</label>
            <input id="contact_no1" name="contact_no1" type="text" />
          </div>
          <div class="f span-6">
            <label for="email_id1">Email Id</label>
            <input id="email_id1" name="email_id1" type="text" />
          </div>
        </div>
      </fieldset>

      <!-- CONTACT 2 -->
      <fieldset>
        <legend>Contact Person 2</legend>
        <div class="grid">
          <div class="f span-6">
            <label for="contact_person2">Contact Person2</label>
            <input id="contact_person2" name="contact_person2" type="text" />
          </div>
          <div class="f">
            <label for="designation2">Designation (2)</label>
            <input id="designation2" name="designation2" type="text" />
          </div>
          <div class="f">
            <label for="contact_no2">Contact No. (2)</label>
            <input id="contact_no2" name="contact_no2" type="text" />
          </div>
          <div class="f span-6">
            <label for="email_id2">Email Id (2)</label>
            <input id="email_id2" name="email_id2" type="text" />
          </div>
        </div>
      </fieldset>

      <!-- SEGMENT -->
      <fieldset>
        <legend>Segment</legend>
        <div class="grid">
          <div class="f span-6">
            <label for="segment">Segment</label>
            <input id="segment" name="segment" type="text" />
          </div>
          <div class="f span-6">
            <label for="sub_segment">Sub-Segment</label>
            <input id="sub_segment" name="sub_segment" type="text" />
          </div>
        </div>
      </fieldset>

      <!-- MACHINE -->
      <fieldset>
        <legend>Machine</legend>
        <div class="grid">
          <div class="f">
            <label for="machine_type">Machine Type</label>
            <input id="machine_type" name="machine_type" type="text" />
          </div>
          <div class="f">
            <label for="model">Model</label>
            <input id="model" name="model" type="text" />
          </div>
          <div class="f">
            <label for="ink_type">Ink type</label>
            <input id="ink_type" name="ink_type" type="text" />
          </div>
          <div class="f">
            <label for="active_status">Active Status</label>
            <input id="active_status" name="active_status" type="text" placeholder="ACTIVE / INACTIVE" />
          </div>
          <div class="f">
            <label for="mc_status">Mc Status</label>
            <input id="mc_status" name="mc_status" type="text" />
          </div>
        </div>
      </fieldset>

      <!-- SALES / INSTALL -->
      <fieldset>
        <legend>Sales / Install</legend>
        <div class="grid">
          <div class="f span-6">
            <label for="sales_invoice_no">Sales Invoice No</label>
            <input id="sales_invoice_no" name="sales_invoice_no" type="text" />
          </div>
          <div class="f">
            <label for="invoice_date">Invoice Date</label>
            <input id="invoice_date" name="invoice_date" type="text" placeholder="YYYY-MM-DD" />
          </div>
          <div class="f">
            <label for="installed_on">Installed On</label>
            <input id="installed_on" name="installed_on" type="text" placeholder="YYYY-MM-DD" />
          </div>
        </div>
      </fieldset>

      <!-- AMC -->
      <fieldset>
        <legend>AMC</legend>
        <div class="grid">
          <div class="f">
            <label for="amc_invoice_date">AMC Invoice Date</label>
            <input id="amc_invoice_date" name="amc_invoice_date" type="text" placeholder="YYYY-MM-DD" />
          </div>
          <div class="f">
            <label for="amc_from">AMC From</label>
            <input id="amc_from" name="amc_from" type="text" placeholder="YYYY-MM-DD" />
          </div>
          <div class="f">
            <label for="amc_to">AMC To</label>
            <input id="amc_to" name="amc_to" type="text" placeholder="YYYY-MM-DD" />
          </div>
          <div class="f">
            <label for="no_of_visits">No. of Visits</label>
            <input id="no_of_visits" name="no_of_visits" type="text" />
          </div>
          <div class="f">
            <label for="amc_amount">AMC Amount</label>
            <input id="amc_amount" name="amc_amount" type="text" />
          </div>
          <div class="f">
            <label for="amc_due_date">AMC Due Date</label>
            <input id="amc_due_date" name="amc_due_date" type="text" placeholder="YYYY-MM-DD" />
          </div>
          <div class="f">
            <label for="amc_days_remaining">AMC Days Remaining</label>
            <input id="amc_days_remaining" name="amc_days_remaining" type="text" />
          </div>
        </div>
      </fieldset>

      <!-- FILTER -->
      <fieldset>
        <legend>Filter</legend>
        <div class="grid">
          <div class="f">
            <label for="filter_invoice_date">Filter Invoice Date</label>
            <input id="filter_invoice_date" name="filter_invoice_date" type="text" placeholder="YYYY-MM-DD" />
          </div>
          <div class="f">
            <label for="filter_days">Filter Days</label>
            <input id="filter_days" name="filter_days" type="text" />
          </div>
          <div class="f">
            <label for="next_filter_due_date">Next Filter Due Date</label>
            <input id="next_filter_due_date" name="next_filter_due_date" type="text" placeholder="YYYY-MM-DD" />
          </div>
          <div class="f">
            <label for="filter_days_remaining">Filter Days Remaining</label>
            <input id="filter_days_remaining" name="filter_days_remaining" type="text" />
          </div>
        </div>
      </fieldset>

      <!-- CLUSTER / PLAN -->
      <fieldset>
        <legend>Visit Plan</legend>
        <div class="grid">
          <div class="f span-6">
            <label for="cluster_visit_plan">Cluster Visit Plan</label>
            <input id="cluster_visit_plan" name="cluster_visit_plan" type="text" />
          </div>
          <div class="f span-6">
            <label for="actual_visit">Actual Visit</label>
            <input id="actual_visit" name="actual_visit" type="text" />
          </div>
          <div class="f">
            <label for="cluster">Cluster</label>
            <input id="cluster" name="cluster" type="text" />
          </div>
        </div>
      </fieldset>

      <!-- REMARKS / TERRITORY -->
      <fieldset>
        <legend>Remarks / Territory</legend>
        <div class="grid">
          <div class="f span-12">
            <label for="remarks">Remarks</label>
            <textarea id="remarks" name="remarks"></textarea>
          </div>
          <div class="f">
            <label for="teritory_no">Teritory No</label>
            <input id="teritory_no" name="teritory_no" type="text" />
          </div>
          <div class="f span-6">
            <label for="next_ter2_plan">NEXT TER2 PLAN</label>
            <input id="next_ter2_plan" name="next_ter2_plan" type="text" />
          </div>
        </div>
      </fieldset>

      <!-- actions -->
      <div class="actions">
        <button class="btn" type="reset">Reset</button>
        <button class="btn primary" type="submit">Save</button>
      </div>
    </form>
  </div>

  <script>
    // Today pill
    const today = new Date();
    document.getElementById("todayPill").textContent = "ðŸ“… Today: " + today.toISOString().slice(0,10);

    // Loading pill helpers
    const loadingPill = document.getElementById("loadingPill");
    function showLoading(text="Loadingâ€¦"){
      if(!loadingPill) return;
      loadingPill.textContent = text;
      loadingPill.style.display = "inline-flex";
      loadingPill.classList.add("loading");
    }
    function hideLoading(){
      if(!loadingPill) return;
      loadingPill.style.display = "none";
      loadingPill.classList.remove("loading");
    }

    function debounce(fn, delay=250){
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), delay); };
    }

    // âœ… Safe JSON fetch (no crash even if 401/HTML)
    async function safeJson(url){
      const r = await fetch(url, {
        method: "GET",
        credentials: "include",
        headers: {"Accept":"application/json"}
      });
      if(!r.ok) return null;
      const ct = (r.headers.get("content-type") || "").toLowerCase();
      if(!ct.includes("application/json")) return null;
      return await r.json().catch(()=>null);
    }

    // âœ… Suggest loader
    async function loadSuggest(apiBase, q, datalistId){
      try{
        if((q || "").trim().length > 0 && (q || "").trim().length < 2) return;
        const data = await safeJson(apiBase + encodeURIComponent(q || ""));
        if(!data) return;

        const dl = document.getElementById(datalistId);
        if(!dl) return;

        dl.innerHTML = (data.items || [])
          .map(x => `<option value="${String(x).replace(/"/g,'&quot;')}"></option>`)
          .join("");
      }catch(e){
        console.log("Suggest error:", e);
      }
    }

    // CUSTOMER suggest
    const cust = document.getElementById("customer_name");
    cust.addEventListener("input", debounce(() => {
      loadSuggest("/api/installbase/customer_suggest?q=", cust.value.trim(), "dl_customer");
    }, 350));
    cust.addEventListener("focus", () => loadSuggest("/api/installbase/customer_suggest?q=", "", "dl_customer"));

    // SERIAL suggest
    const serial = document.getElementById("serial_no");
    serial.addEventListener("input", debounce(() => {
      loadSuggest("/api/installbase/serial_suggest?q=", serial.value.trim(), "dl_serial");
    }, 350));
    serial.addEventListener("focus", () => loadSuggest("/api/installbase/serial_suggest?q=", "", "dl_serial"));

    function setVal(id, v){
      const el = document.getElementById(id);
      if(el) el.value = (v ?? "");
    }

    function normKey(s){
      return String(s || "").toLowerCase().replace(/[^a-z0-9]/g,'');
    }

    function formElements(){
      return Array.from(document.querySelectorAll("#installbaseForm input[name], #installbaseForm textarea[name]"));
    }

    // âœ… Fill form from DB row (keys are DB columns)
    function fillFromDbRow(dbRow){
      const dbMap = {};
      Object.keys(dbRow || {}).forEach(k => dbMap[normKey(k)] = k);

      formElements().forEach(el => {
        const n = normKey(el.name);
        const dbKey = dbMap[n];
        if(dbKey !== undefined){
          el.value = (dbRow[dbKey] ?? "");
        }
      });
    }

    // âœ… Load by CUSTOMER (fill first machine + serial list)
    async function loadByCustomer(customer){
      if(!customer) return;
      showLoading("Loading customerâ€¦");
      try{
        const data = await safeJson(`/api/installbase/rows?customer=${encodeURIComponent(customer)}`);
        if(!data || !data.ok) return;

        const rows = data.rows || [];
        if(rows.length === 0) return;

        // fill first row
        fillFromDbRow(rows[0]);

        // set serial list for this customer (multiple machines)
        const dl = document.getElementById("dl_serial");
        if(dl){
          const serials = rows
            .map(r => (r["Serial No."] || r["Serial No"] || r["Serial_No"] || r["SERIAL NO"] || r["SerialNo"] || r["Serial"] || "").trim())
            .filter(v => v);

          dl.innerHTML = serials
            .map(v => `<option value="${String(v).replace(/"/g,'&quot;')}"></option>`)
            .join("");
        }
      } finally {
        hideLoading();
      }
    }

    // âœ… Load by SERIAL (autofill full row)
    async function loadBySerial(s){
      if(!s) return;
      showLoading("Loading serialâ€¦");
      try{
        const data = await safeJson(`/api/installbase/by-serial?serial=${encodeURIComponent(s)}`);
        if(!data || !data.ok || !data.row) return;
        fillFromDbRow(data.row);
      } finally {
        hideLoading();
      }
    }

    // events
    cust.addEventListener("change", () => loadByCustomer(cust.value.trim()));
    cust.addEventListener("blur",   () => loadByCustomer(cust.value.trim()));

    serial.addEventListener("change", () => loadBySerial(serial.value.trim()));
    serial.addEventListener("blur",   () => loadBySerial(serial.value.trim()));

    // âœ… SAVE with confirm: if serial exists => ask update yes/no
    document.getElementById("installbaseForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = Object.fromEntries(fd.entries());

      if(!payload.customer_name || !payload.serial_no){
        alert("Customer Name & Serial No required!");
        return;
      }

      showLoading("Checkingâ€¦");
      try{
        const chk = await safeJson(`/api/installbase/exists?serial=${encodeURIComponent(payload.serial_no)}`);

        if(chk && chk.ok && chk.exists === true){
          hideLoading();
          const yes = confirm("Ye Serial No. already database me hai.\nAap UPDATE karna chahte ho?");
          if(!yes){
            alert("Update cancelled.");
            return;
          }
        }

        showLoading("Savingâ€¦");
        const r = await fetch("/api/installbase/save", {
          method: "POST",
          credentials: "include",
          headers: {"Content-Type":"application/json", "Accept":"application/json"},
          body: JSON.stringify(payload)
        });

        const j = await r.json().catch(()=>null);
        if(!r.ok || !j || !j.ok){
          alert((j && j.message) ? j.message : "Save failed");
          return;
        }
        alert(j.message || "Saved!");
      }catch(err){
        console.log(err);
        alert("Network error while saving.");
      }finally{
        hideLoading();
      }
    });
  </script>
</body>
</html>
