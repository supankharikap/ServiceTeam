<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KGK Jet India ERP</title>

  <style>
    :root{
      --bg:#eef4ff; --card:#ffffff; --primary:#1a73e8;
      --text:#0f172a; --muted:#64748b; --border:#e5e7eb;
      --shadow: 0 10px 25px rgba(0,0,0,.08); --radius: 14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Segoe UI",system-ui,-apple-system,Arial;background:var(--bg);color:var(--text);}
    .app{display:grid;grid-template-columns:260px 1fr;min-height:100vh;}

    .sidebar{background:#0b2a55;color:#fff;padding:18px;position:sticky;top:0;height:100vh;}
    .brand{display:flex;align-items:center;gap:10px;padding:10px 10px 18px;border-bottom:1px solid rgba(255,255,255,.12);margin-bottom:14px;}
    .logo{width:46px;height:46px;border-radius:14px;background:linear-gradient(135deg,#1a73e8,#2e7d32);display:flex;align-items:center;justify-content:center;font-weight:900;}
    .brand h2{margin:0;font-size:16px;line-height:1.1}
    .brand small{color:rgba(255,255,255,.7)}
    .nav{margin-top:14px;display:flex;flex-direction:column;gap:10px;}
    .nav button{border:none;background:rgba(255,255,255,.08);color:#fff;padding:12px;border-radius:12px;cursor:pointer;text-align:left;display:flex;align-items:center;gap:10px;font-size:14px;transition:.2s;}
    .nav button:hover{background:rgba(255,255,255,.16)}
    .nav button.active{background:rgba(26,115,232,.35);outline:1px solid rgba(26,115,232,.55);}
    .sidebarFooter{position:absolute;left:18px;right:18px;bottom:18px;background:rgba(255,255,255,.08);border-radius:12px;padding:12px;font-size:13px;color:rgba(255,255,255,.85);}
    .sidebarFooter b{color:#fff}

    .main{padding:18px 18px 28px;}
    .topbar{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px 16px;display:flex;gap:14px;justify-content:space-between;align-items:center;}
    .topbar .title{display:flex;flex-direction:column;}
    .topbar h1{margin:0;font-size:18px}
    .topbar .sub{color:var(--muted);font-size:13px}
    .userBox{display:flex;align-items:center;gap:12px;}
    .pill{padding:8px 10px;border-radius:999px;background:#f1f5ff;border:1px solid #dbe6ff;font-size:13px;}
    .logout{background:#fff;border:1px solid var(--border);padding:8px 12px;border-radius:10px;cursor:pointer;}

    .cards{margin-top:14px;display:grid;grid-template-columns:repeat(4,1fr);gap:12px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;}
    .card .kpi{font-size:22px;font-weight:800}
    .card .label{color:var(--muted);font-size:13px}

    .section{margin-top:14px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;display:none;}
    .section.active{display:block;}
    .sectionHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
    .sectionHeader h2{margin:0;font-size:16px}
    .sectionHeader small{color:var(--muted)}

    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:12px;font-size:14px;outline:none;background:#fff;}
    textarea{min-height:90px;resize:vertical;}
    .actions{margin-top:12px;display:flex;gap:10px;justify-content:flex-end;}
    .btn{border:none;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700;}
    .btn.primary{background:var(--primary);color:#fff;}
    .btn.gray{background:#f1f5f9;border:1px solid var(--border);}

    .tableWrap{overflow:auto;border:1px solid var(--border);border-radius:12px;}
    table{width:100%;border-collapse:collapse;font-size:13px;min-width:900px;}
    thead th{position:sticky;top:0;background:#0b2a55;color:#fff;padding:10px;text-align:left;white-space:nowrap;}
    tbody td{border-top:1px solid var(--border);padding:10px;white-space:nowrap;}

    .searchRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px;}
    .searchRow input{flex:1;min-width:260px;}
    .hint{color:var(--muted);font-size:12px;margin-top:6px;}
    .err{color:#b91c1c;font-weight:700;}

    .suggestBox{
      position:absolute; display:none; background:#fff; border:1px solid #e5e7eb; border-radius:12px;
      box-shadow:0 18px 40px rgba(0,0,0,.12); width:520px; max-width:100%; max-height:240px; overflow:auto;
      z-index:9998; left:0; top:44px;
    }
    .suggestItem{padding:10px 12px;cursor:pointer;border-bottom:1px solid #f1f5f9;}
    .suggestItem:hover{background:#f8fafc;}

    @media (max-width:1100px){
      .cards{grid-template-columns:repeat(2,1fr)}
      .grid{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width:800px){
      .app{grid-template-columns:1fr}
      .sidebar{height:auto;position:relative}
      .cards{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
      table{min-width:650px}
      .sidebarFooter{position:relative;left:0;right:0;bottom:0;margin-top:12px;}
    }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">KGK</div>
        <div>
          <h2>KGK Jet India</h2>
          <small>Service ERP</small>
        </div>
      </div>

      <div class="nav">
        <button id="btnDashboard" class="active" onclick="showSection('dashboardSection', this)">üè† Dashboard</button>
        <button id="btnWsr" onclick="showSection('wsrSection', this)">üßæ WSR Report</button>
        <button id="btnReport" onclick="showSection('reportSection', this); loadReport();">üìã Report View</button>
        <button onclick="showSection('masterSection', this); openMaster();">üìÑ Master Installbase View</button>
        <button onclick="showSection('masterSection', this); openMaster();">‚úÖ Master Installbase Update</button>
        <button onclick="showSection('masterSection', this); openMaster();">‚úÖ Breakdown Login</button>
        <button onclick="showSection('masterSection', this); openMaster();">‚úÖ Weekly Plan</button>
      </div>

      <div class="sidebarFooter">
        <div><b id="sbEngineer">Engineer</b></div>
        <div>Team: <span id="sbZone">-</span></div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="title">
          <h1>Service Dashboard</h1>
          <div class="sub">KGK SERVICE TEAM LOGIN ERP</div>
        </div>

        <div class="userBox">
          <div class="pill">üë§ <b id="engName">-</b></div>
          <div class="pill">üìç Zone: <b id="zoneName">-</b></div>
          <button class="logout" onclick="logout()">Logout</button>
        </div>
      </div>

      <div class="cards">
        <div class="card">
          <div class="kpi" id="kpiTotal">‚Äî</div>
          <div class="label">Total InstallBase</div>
        </div>
        <div class="card">
          <div class="kpi" id="kpiMonth">‚Äî</div>
          <div class="label">This Month Cluster Plan</div>
        </div>
        <div class="card">
          <div class="kpi" id="kpiPending">0</div>
          <div class="label">Breakdown Task Pending</div>
        </div>
        <div class="card">
          <div class="kpi" id="kpiCustomers">‚Äî</div>
          <div class="label">Total Customers</div>
        </div>
      </div>

      <section id="dashboardSection" class="section active">
        <div class="sectionHeader">
          <h2>Overview</h2>
          <small>Welcome to KGK Service Team ERP</small>
        </div>
        <div style="color:var(--muted); line-height:1.6">
          ‚úÖ Use left menu to open WSR Form, Report View, Master InstallBase.<br>
          ‚úÖ Engineer and Zone are loaded automatically from Login.
        </div>
      </section>

      <!-- MASTER -->
      <section id="masterSection" class="section">
        <div class="sectionHeader">
          <h2>Master InstallBase</h2>
          <small id="masterHint">‚Äî</small>
        </div>

        <div style="position:relative; margin:0 0 10px;">
          <div class="searchRow">
            <input id="masterSearch" placeholder="Search (Customer / Serial / Engineer / Zone...)" autocomplete="off">
            <button class="btn gray" onclick="masterDoSearch()">üîé Search</button>
            <button class="btn gray" onclick="masterClear()">‚úñ Clear</button>
            <button class="btn gray" onclick="openMaster()">üîÑ Refresh</button>
          </div>
          <div id="masterSuggest" class="suggestBox"></div>
          <div id="masterErr" class="err"></div>
        </div>

        <div id="masterTable"></div>
      </section>

      <!-- WSR FORM -->
      <section id="wsrSection" class="section">
        <div class="sectionHeader">
          <h2>WSR Report Form</h2>
          <small>Submit service activity</small>
        </div>

        <form id="wsrForm">
          <div class="grid">
          <div><label>Zone</label><input id="wsr_zone" name="zone" readonly></div>
          <div><label>Engineer</label><input id="wsr_engineer" name="engineerName" readonly></div>
          <div><label>Month/Year</label><input name="monthYear" placeholder="MMM-YY" required></div>

          <div><label>Service Report No</label><input name="serviceReportNo"></div>

          <!-- Customer Name suggest -->
          <div style="position:relative;">
          <label>Customer Name</label>
          <input id="customerNameInput" name="customerName" autocomplete="off" placeholder="Type customer name...">
          <div id="customerSuggest" class="suggestBox" style="width:100%; top:70px;"></div>
          </div>

          <div><label>Location</label><input name="location"></div>

          <div><label>Contact Person</label><input name="contactPerson"></div>
          <div><label>Designation</label><input name="designation"></div>
          <div><label>Contact Number</label><input name="contactNumber"></div>

          <div><label>Email</label><input name="email"></div>
          <div><label>Call Logged Date</label><input type="date" name="callLoggedDate"></div>
          <div><label>Problem Reported</label><input name="problemReported"></div>

          <div><label>Machine Status</label><input name="machineStatus"></div>

          <div>
          <label>Visit Code 1</label>
          <select id="visitCode1" name="visitCode1" required>
          <option value="">--Select--</option>
          <option value="NA">NA</option>
          <option value="CLUSTER">CLUSTER</option>
          <option value="BREAKDOWN">BREAKDOWN</option>
          <option value="SALES SUPPORTS">SALES SUPPORTS</option>
          <option value="OTHERS ">OTHERS TEC</option>
          </select>
         </div>

         <div>
         <label>Visit Code 2</label>
         <select id="visitCode2" name="visitCode2">
         <option value="">--Select--</option>
         </select>
         </div>

          <!-- Machine details (Excel headers) -->
         <div><label>Printer Model</label><input name="printerModel"></div>
         <div><label>M/C No</label><input name="mcNo"></div>
         <div><label>Serial No</label><input name="serialNo"></div>

         <div><label>Ink Type</label><input name="inkType"></div>
         <div><label>Turn on Time (Hrs)</label><input name="turnOnTime" type="number" step="0.1" placeholder="e.g. 120.5"></div>
         <div><label>Print on Time (Hrs)</label><input name="printOnTime" type="number" step="0.1" placeholder="e.g. 85.0"></div>

         <div><label>Visit Date</label><input type="date" name="visitDate"></div>

         <!-- Travel time -->
         <div><label>Travel Start (HH:MM)</label><input id="travelStart" name="travelStart" type="time"></div>
         <div><label>Travel End (HH:MM)</label><input id="travelEnd" name="travelEnd" type="time"></div>
         <div><label>TRAVEL TIME</label><input id="travelTime" name="travelTime" readonly placeholder="auto"></div>

         <!-- Work time -->
         <div><label>Work Start (HH:MM)</label><input id="workStart" name="workStart" type="time"></div>
         <div><label>Work End (HH:MM)</label><input id="workEnd" name="workEnd" type="time"></div>
         <div><label>WORK TIME</label><input id="workTime" name="workTime" readonly placeholder="auto"></div>

         <!-- Action / remarks -->
         <div style="grid-column:1/-1;">
         <label>Action Taken (in brief)</label>
         <textarea name="actionTaken"></textarea>
         </div>

         <!-- Consumables -->
         <div><label>INK (Qty)</label><input name="ink" type="number" step="0.01" placeholder="0.00"></div>
         <div><label>Solvent (Qty)</label><input name="solvent" type="number" step="0.01" placeholder="0.00"></div>
         <div><label>CNC (Qty)</label><input name="cnc" type="number" step="0.01" placeholder="0.00"></div>

         <div><label>Filter Kit Due Date/Hrs</label><input name="filterKitDue" placeholder="Due date / hrs"></div>
          <div><label>Customer Feedback</label><input name="customerFeedback"></div>

         <div>
          <label>Call Status</label>
          <select name="callStatus">
          <option value="">--Select--</option>
          <option value="OPEN">OPEN</option>
          <option value="CLOSED">CLOSED</option>
          <option value="PENDING">PENDING</option>
         </select>
          </div>

          <div>
          <label>Re-visit Required</label>
          <select name="revisitRequired">
          <option value="">--Select--</option>
          <option value="YES">YES</option>
          <option value="NO">NO</option>
          </select>
          </div>

          <div style="grid-column:1/-1;">
          <label>Service Engineer Remarks</label>
          <textarea name="serviceEngineerRemarks"></textarea>
          </div>

          <div style="grid-column:1/-1;">
          <label>Service Manager Remarks</label>
          <textarea name="serviceManagerRemarks"></textarea>
          </div>
          </div>

          <div class="actions">
          <button type="button" class="btn gray" onclick="document.getElementById('wsrForm').reset(); refillReadonly(); resetVisitCode2();">Clear</button>
          <button type="submit" class="btn primary">Submit WSR</button>
          </div>
        </form>
      </section>

      <!-- REPORT -->
      <section id="reportSection" class="section">
        <div class="sectionHeader">
          <h2>Report View</h2>
          <small>dbo.WSR table view</small>
        </div>

        <div style="position:relative; margin:0 0 10px;">
          <div class="searchRow">
            <input id="reportSearch" placeholder="Search report (customer / report no / engineer / zone...)" autocomplete="off">
            <button class="btn gray" onclick="reportDoSearch()">üîé Search</button>
            <button class="btn gray" onclick="reportClear()">‚úñ Clear</button>
            <button class="btn gray" onclick="loadReport()">üîÑ Refresh</button>
          </div>
          <div id="reportSuggest" class="suggestBox"></div>
          <div id="reportErr" class="err"></div>
        </div>

        <div id="reportWrap" class="tableWrap">
          <table id="dataTable">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

    </main>
  </div>

<script>
const SERVER_ENGINEER = "{{ engineer|e }}";
const SERVER_ZONE = "{{ zone|e }}";
const SERVER_ROLENAME = "{{ role|e }}";
const SERVER_TEAM = "{{ team|e }}";

function showSection(id, btn){
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  const sec = document.getElementById(id);
  if (sec) sec.classList.add("active");

  document.querySelectorAll(".nav button").forEach(b=>b.classList.remove("active"));
  if(btn) btn.classList.add("active");
}

function refillReadonly(){
  const e1 = document.getElementById("wsr_engineer");
  const z1 = document.getElementById("wsr_zone");
  if (e1) e1.value = SERVER_ENGINEER || "";
  if (z1) z1.value = SERVER_ZONE || "";
}

function logout(){
  window.location.href = "/logout";
}

function loadKpis(){
  fetch("/api/kpi")
    .then(r => r.json())
    .then(k => {
      if (k.error) return;
      document.getElementById("kpiTotal").textContent = k.installbase_total ?? 0;
      document.getElementById("kpiCustomers").textContent = k.customers ?? 0;
      document.getElementById("kpiMonth").textContent = k.this_month_reports ?? 0;
      document.getElementById("kpiPending").textContent = k.pending ?? 0;
    })
    .catch(()=>{});
}

function escapeHtml(v){
  if (v === null || v === undefined) return "";
  return String(v)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function renderTable(columns, rows) {
  if (!rows || rows.length === 0) return "<div>No data found</div>";

  const th = columns.map(c => `<th>${escapeHtml(c)}</th>`).join("");
  const body = rows.map(r => {
    const tds = columns.map(c => `<td>${escapeHtml(r[c])}</td>`).join("");
    return `<tr>${tds}</tr>`;
  }).join("");

  return `
    <div style="overflow:auto; max-height:70vh; border:1px solid #e5e7eb; border-radius:12px;">
      <table style="width:100%; border-collapse:collapse;">
        <thead><tr>${th}</tr></thead>
        <tbody>${body}</tbody>
      </table>
    </div>
  `;
}

/* ================= VISIT CODE 1 -> VISIT CODE 2 (DEPENDENT DROPDOWN) ================= */
const visit2Map = {
  "CLUSTER": ["Gen PM", "Filter PM", "Courtesy"],
  "BREAKDOWN": ["First Visit", "Carryover", "Repeat Visit"],
  "SALES SUPPORTS": ["Demo Install", "Demo Carryover", "Site Survey", "Sampling", "Exhibition", "Demo in Office"],
  "OTHERS ": [
    // Special Application
    "Line Study", "First Visit", "Carryover Visit",
    // Training
    "Onsite", "Other Venue", "KGK Office",
    // Refurbishment
    "KGK Workshop",
    // Other Visit
    "S/W Upgrade", "Courtesy", "Sales Contract", "Order Followup", "Payment Followup"
  ],
  "NA": []
};

function fillVisitCode2(list){
  const v2 = document.getElementById("visitCode2");
  if (!v2) return;
  v2.innerHTML = `<option value="">--Select--</option>`;
  (list || []).forEach(text => {
    const opt = document.createElement("option");
    opt.value = text;
    opt.textContent = text;
    v2.appendChild(opt);
  });
}
function resetVisitCode2(){
  fillVisitCode2([]);
}
function initVisitCodeDependency(){
  const v1 = document.getElementById("visitCode1");
  if (!v1) return;

  v1.addEventListener("change", () => {
    const val = v1.value;
    if (!val || val === "NA") {
      resetVisitCode2();
      return;
    }
    fillVisitCode2(visit2Map[val] || []);
  });

  // page load (edit mode)
  if (v1.value) {
    fillVisitCode2(visit2Map[v1.value] || []);
  }
}

/* ================= CUSTOMER SUGGEST (InstallBase) ================= */

// helper: WSR form ke field ko safely set karo
function setWsrField(name, value){
  const form = document.getElementById("wsrForm");
  if (!form) return;
  const el = form.querySelector(`[name="${name}"]`);
  if (!el) return;
  el.value = (value ?? "");
}

// InstallBase details fill
async function fillCustomerDetails(customerName){
  const customer = (customerName || "").trim();
  if (!customer) return;

  try{
    const res = await fetch("/api/installbase/details?customer=" + encodeURIComponent(customer));
    const j = await res.json();

    if (!res.ok || !j.ok || !j.found) return;

    const d = j.data || {};

    // form fields (aapke form me jo-jo exist hai)
    setWsrField("location", d.location);
    setWsrField("contactPerson", d.contact_person);
    setWsrField("designation", d.designation);
    setWsrField("contactNumber", d.contact_no);
    setWsrField("email", d.email);
    setWsrField("inkType", d.ink_type);

    // machine status preference
    setWsrField("machineStatus", d.mc_status || d.active_status);

  }catch(e){
    console.log("details error", e);
  }
}

function initCustomerSuggest(){
  const input = document.getElementById("customerNameInput");
  const box = document.getElementById("customerSuggest");
  if (!input || !box) return;

  let timer = null;

  input.addEventListener("input", (e) => {
    const q = (e.target.value || "").trim();
    if (q.length < 2) { hideSuggest("customerSuggest"); return; }

    clearTimeout(timer);
    timer = setTimeout(async () => {
      try{
        // ‚úÖ customer-only suggestions (BEST)
        const res = await fetch("/api/installbase/customer_suggest?q=" + encodeURIComponent(q));
        const data = await res.json();
        const items = data.items || [];

        if (!items.length){ hideSuggest("customerSuggest"); return; }

        box.innerHTML = items
          .map(v => `<div class="suggestItem" data-v="${escapeHtml(v)}">${escapeHtml(v)}</div>`)
          .join("");
        box.style.display = "block";
      }catch{
        hideSuggest("customerSuggest");
      }
    }, 200);
  });

  // click suggestion => set customer + autofill
  box.addEventListener("click", async (e) => {
    const it = e.target.closest(".suggestItem");
    if (!it) return;

    const val = it.getAttribute("data-v") || "";
    input.value = val;
    hideSuggest("customerSuggest");

    await fillCustomerDetails(val);
  });

  // agar user manually type karke bahar click kare
  input.addEventListener("blur", () => {
    const val = (input.value || "").trim();
    if (val.length >= 2) fillCustomerDetails(val);
  });

  // Enter press => autofill
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter"){
      e.preventDefault();
      const val = (input.value || "").trim();
      if (val) fillCustomerDetails(val);
      hideSuggest("customerSuggest");
    }
  });
}

/* ================= MASTER ================= */
async function openMaster(){
  const hint = document.getElementById("masterHint");
  const holder = document.getElementById("masterTable");
  const errBox = document.getElementById("masterErr");
  errBox.textContent = "";

  hint.textContent = "Loading...";
  holder.innerHTML = "Loading...";

  const q = (document.getElementById("masterSearch").value || "").trim();

  try {
    const res = await fetch("/api/master/installbase?limit=2000&q=" + encodeURIComponent(q));
    const data = await res.json();

    if (!res.ok) {
      hint.textContent = "Error";
      errBox.textContent = data.error || "Error";
      holder.innerHTML = "";
      return;
    }

    hint.textContent = `Rows: ${(data.rows||[]).length}`;
    holder.innerHTML = renderTable(data.columns || [], data.rows || []);
    loadKpis();
  } catch (e) {
    hint.textContent = "Network error";
    errBox.textContent = String(e);
    holder.innerHTML = "";
  }
}

function masterDoSearch(){ openMaster(); }
function masterClear(){
  document.getElementById("masterSearch").value = "";
  hideSuggest("masterSuggest");
  openMaster();
}

/* master suggestions */
/* master suggestions (SAFE) */
const msInput = () => document.getElementById("masterSearch");
const _ms = msInput();

if (_ms){
  _ms.addEventListener("input", async (e)=>{
    const q = (e.target.value || "").trim();
    if (q.length < 2){ hideSuggest("masterSuggest"); return; }
    const box = document.getElementById("masterSuggest");
    try{
      const res = await fetch("/api/master/installbase/suggest?q=" + encodeURIComponent(q));
      const data = await res.json();
      const items = data.items || [];
      if (!items.length){ hideSuggest("masterSuggest"); return; }
      box.innerHTML = items.map(v => `<div class="suggestItem" data-v="${escapeHtml(v)}">${escapeHtml(v)}</div>`).join("");
      box.style.display = "block";
    }catch{
      hideSuggest("masterSuggest");
    }
  });
}
// ‚úÖ master suggestion click => set value + search
const masterSuggestBox = document.getElementById("masterSuggest");
if (masterSuggestBox){
  masterSuggestBox.addEventListener("click", (e)=>{
    const it = e.target.closest(".suggestItem");
    if (!it) return;

    msInput().value = it.getAttribute("data-v") || "";
    hideSuggest("masterSuggest");
    openMaster();
  });
}


/* ================= REPORT ================= */
function reportDoSearch(){ loadReport(); }
function reportClear(){
  document.getElementById("reportSearch").value = "";
  hideSuggest("reportSuggest");
  loadReport();
}

async function loadReport(){
  const errBox = document.getElementById("reportErr");
  errBox.textContent = "";
  const q = (document.getElementById("reportSearch").value || "").trim();

  try{
    const res = await fetch("/api/report?limit=2000&q=" + encodeURIComponent(q));
    const data = await res.json();
    if (!res.ok || data.error){
      errBox.textContent = data.error || "Report load error";
      return;
    }

    const thead = document.querySelector("#dataTable thead");
    const tbody = document.querySelector("#dataTable tbody");
    thead.innerHTML = "";
    tbody.innerHTML = "";

    const cols = data.columns || [];
    const rows = data.rows || [];

    if (!cols.length) return;

    const trh = document.createElement("tr");
    cols.forEach(h=>{
      const th = document.createElement("th");
      th.textContent = h;
      trh.appendChild(th);
    });
    thead.appendChild(trh);

    rows.forEach(r=>{
      const tr = document.createElement("tr");
      cols.forEach(c=>{
        const td = document.createElement("td");
        td.textContent = (r[c] === null || r[c] === undefined) ? "" : r[c];
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }catch(e){
    errBox.textContent = String(e);
  }
}

/* report suggestions */
const rsInput = () => document.getElementById("reportSearch");
rsInput().addEventListener("input", async (e)=>{
  const q = (e.target.value || "").trim();
  if (q.length < 2){ hideSuggest("reportSuggest"); return; }
  const box = document.getElementById("reportSuggest");
  try{
    const res = await fetch("/api/report/suggest?q=" + encodeURIComponent(q));
    const data = await res.json();
    const items = data.items || [];
    if (!items.length){ hideSuggest("reportSuggest"); return; }
    box.innerHTML = items.map(v => `<div class="suggestItem" data-v="${escapeHtml(v)}">${escapeHtml(v)}</div>`).join("");
    box.style.display = "block";
  }catch{
    hideSuggest("reportSuggest");
  }
});
document.getElementById("reportSuggest").addEventListener("click", (e)=>{
  const it = e.target.closest(".suggestItem");
  if (!it) return;
  rsInput().value = it.getAttribute("data-v") || "";
  hideSuggest("reportSuggest");
  loadReport();
});

/* generic hide */
function hideSuggest(id){
  const box = document.getElementById(id);
  if (!box) return;
  box.style.display = "none";
  box.innerHTML = "";
}
document.addEventListener("click", (e)=>{
  if (!e.target.closest("#masterSearch") && !e.target.closest("#masterSuggest")) hideSuggest("masterSuggest");
  if (!e.target.closest("#reportSearch") && !e.target.closest("#reportSuggest")) hideSuggest("reportSuggest");
  if (!e.target.closest("#customerNameInput") && !e.target.closest("#customerSuggest")) hideSuggest("customerSuggest");
});

/* ================= WSR SUBMIT ================= */
document.getElementById("wsrForm").addEventListener("submit", function(e){
  e.preventDefault();
  const form = e.target;
  const data = Object.fromEntries(new FormData(form).entries());

  data.engineerName = SERVER_ENGINEER || "";
  data.zone = SERVER_ZONE || "";

  fetch("/api/wsr", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(data)
  })
  .then(r => r.json())
  .then(res => {
    alert(res.message || "Saved");
    if (res.ok){
      form.reset();
      refillReadonly();
      resetVisitCode2();
      loadReport();
    }
  })
  .catch(()=> alert("Error saving WSR"));
});

/* INIT */
window.onload = function(){
  document.getElementById("engName").textContent = SERVER_ENGINEER || "-";
  document.getElementById("zoneName").textContent = SERVER_ZONE || "-";
  document.getElementById("sbEngineer").textContent = SERVER_ROLENAME || "-";
  document.getElementById("sbZone").textContent = SERVER_TEAM || "-";


  function parseHHMM(t){
  if (!t) return null;
  const [h,m] = t.split(":").map(Number);
  if (Number.isNaN(h) || Number.isNaN(m)) return null;
  return h*60 + m;
}
function fmtHHMM(mins){
  const h = Math.floor(mins/60);
  const m = mins % 60;
  return String(h).padStart(2,"0") + ":" + String(m).padStart(2,"0");
}
function calcDuration(start, end){
  const s = parseHHMM(start), e = parseHHMM(end);
  if (s === null || e === null) return "";
  let diff = e - s;
  if (diff < 0) diff += 24*60; // if next day
  return fmtHHMM(diff);
}
function initTimeAutoCalc(){
  const ts = document.getElementById("travelStart");
  const te = document.getElementById("travelEnd");
  const tt = document.getElementById("travelTime");

  const ws = document.getElementById("workStart");
  const we = document.getElementById("workEnd");
  const wt = document.getElementById("workTime");

  function updTravel(){ if(tt) tt.value = calcDuration(ts?.value, te?.value); }
  function updWork(){ if(wt) wt.value = calcDuration(ws?.value, we?.value); }

  ts?.addEventListener("input", updTravel);
  te?.addEventListener("input", updTravel);
  ws?.addEventListener("input", updWork);
  we?.addEventListener("input", updWork);

}

  refillReadonly();
  loadKpis();

  initVisitCodeDependency();  // ‚úÖ Visit Code 2 dependent
  initCustomerSuggest();      // ‚úÖ Customer suggestion from InstallBase
  initTimeAutoCalc();

};
</script>

</body>
</html>
